<!DOCTYPE html>
<html>
<head>
  <title>Braille Display Controller</title>
  <meta charset="utf-8">
  <!-- import bootstrap 5.1 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/b33dd8950a.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="jumbotron" style="justify-content: center; text-align: center;">
  
  <h1 class="pt-4">Shape App</h1>
  <h3 id="connection-status"></h3>
  <div class="py-3">
    <button class="btn btn-primary" id="connectButton">Connect to Arduino</button>
    <button class="btn btn-danger" onclick="sendData('0000000000000000000000000000000000000000000000000000000000000000')">Clear Display</button>
  </div>
  <div class="pt-2">
    <button class="btn btn-primary p-3 m-1" onclick="sendData('0001100001100110010000101000000110000001010000100110011000011000')">
      <p>Send Circle</p>
      <i class="fa-regular fa-circle fa-3x"></i>
    </button>
    <button class="btn btn-primary p-3 m-1" onclick="sendData('0000000001111110010000100100001001000010010000100111111000000000')">
      <p>Send Square</p>
      <i class="fa-regular fa-square fa-3x"></i>
    </button>
    <button class="btn btn-primary p-3 m-1" onclick="sendData('0000000000000000000100000010100001000100111111100000000000000000')">
      <p>Send Triangle</p>
      <i class="fa-solid fa-caret-up fa-3x"></i>
    </button>
    <button class="btn btn-primary p-3 m-1" onclick="sendData('0000000001101100100100101000001001000100001010000001000000000000')">
      <p>Send Heart</p>
      <i class="fa-solid fa-heart fa-3x"></i>
    </button>
    <button class="btn btn-primary p-3 m-1" onclick="sendData('1000001001000100001010000001000000101000010001001000001000000000')">
      <p>Send X-Cross</p>
      <i class="fa-solid fa-times fa-3x"></i>
    </button>
    <button class="btn btn-primary p-3 m-1" onclick="sendData('0001000000010000000100001111111000010000000100000001000000000000')">
      <p>Send Plus-Cross</p>
      <i class="fa-solid fa-plus fa-3x"></i>
    </button>
  </div>
  <div class="d-flex justify-content-center py-4">
   <div class="p-2 w-75">
     <h2>Number Sender</h2>
     <p>Enter a number (From -9999 to 99999) or a one-step operation (2+10) to send to the arduino.</p>
     <div class="input-group m-3">
       <input class="form-control" type="text" id="numberInput" min="0" max="99999" value="0">
       <div class="input-group-append">
         <button class="btn btn-primary" onclick="sendNumber()">Send Number</button>
       </div>
     </div>
   </div>
   </div>
   <div class="d-flex justify-content-center py-4">
    <button class="btn btn-primary" onclick="toggleCustomShapes()" id="customShapeEnablerButton">Enable Custom Shapes</button>
   </div>
   <div class="d-flex justify-content-center py-4" style="display: none !important;" id="customShapeConfigurator">
     <div class="p-2 w-75">
       <h2>Create a Custom Shape</h2>
        <p>Click on the cells to create a custom shape, then click "Send Custom Shape" to send it to the arduino.</p>
        <div class="pt-2 d-flex justify-content-center align-items-center"> 
              <table id="checkboxHolder" class="grid">
              </table>
              <script>
                // Script to generate a 8 row by 8 column table of checkboxes to create a shape
                var table = document.getElementById("checkboxHolder");
                for (var i = 0; i < 8; i++) {
                    var row = table.insertRow(i);
                    row.className = "p-0 m-0 gridRow";
                    for (var j = 0; j < 8; j++) {
                        var cell = row.insertCell(j);
                        var checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.id = "checkbox" + i + j;
                        checkbox.name = "checkbox" + i + j;
                        checkbox.className = "checkbox";
                        cell.className="px-2 pt-1"
                        checkbox.value = "value";
                        cell.appendChild(checkbox);
                    }
                }
            </script>
        </div>
        <input class="form-control" type="text" id="customShapeName" placeholder="Shape Name">
        <div class="pt-2">
          <button class="btn btn-primary" onclick="createCustomShape()">Add Custom Shape to Library</button>
        </div>
        <div class="div pt-2" id="customShapeLibrary">
        </div>
      </div>
    </div>
  
  <script>
    // display the custom shapes section if the user has enabled it
    if (localStorage.getItem('customShapesEnabled') == 'true') {
      document.getElementById('customShapeConfigurator').style.display = 'block';
      document.getElementById('customShapeEnablerButton').textContent = 'Disable Custom Shapes';
      document.getElementById('customShapeEnablerButton').classList.remove('btn-primary');
      document.getElementById('customShapeEnablerButton').classList.add('btn-warning');

      // get all shapes from local storage and display them in the custom shapes section
      const customShapes = JSON.parse(localStorage.getItem('customShapes'));
      if (customShapes) {
        // iterate through all
        for (const shape of customShapes) {
          const shapeButton = document.createElement('button');
          shapeButton.className = 'btn btn-primary p-3 m-1';
          shapeButton.textContent = shape.name;
          shapeButton.onclick = () => sendData(shape.data);
          document.getElementById('customShapeLibrary').appendChild(shapeButton);
        }
      }
    }


    // toggling custom shapes
    function toggleCustomShapes() {
      if (localStorage.getItem('customShapesEnabled') == 'true') {
        localStorage.setItem('customShapesEnabled', 'false');
        location.reload();
      } else {
        if (!confirm("Enabling custom shapes will allow you to create your own shapes, but these have not been tested for ease-of-readability. Are you sure you want to enable custom shapes?")) {
          return;
        }
        localStorage.setItem('customShapesEnabled', 'true');
        location.reload();
      }
    }

    let serialPort;
    const connectButton = document.getElementById('connectButton');

    async function sendData(data) {
      if (!serialPort || !serialPort.writable) {
        console.error('Serial port not connected or not writable.');
        if(!serialPort) {
          alert('Please connect to the serial port first.');
          return;
        }
        else if(!serialPort.writable) {
          alert('Serial port is not writable. Please reconnect.');
        }
        return;
      }

      // encodes the data being sent to the arduino port
      const encoder = new TextEncoder();
      const dataArray = encoder.encode(data);

      // writing to the serial port of the arduino
      const writer = serialPort.writable.getWriter();
      await writer.write(dataArray);
      writer.releaseLock();
      console.log('Data sent to Arduino:', data);
    }

    // connection for the arduino
    connectButton.addEventListener('click', async () => {
      try {
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 9600 });
        console.log('Serial port connected.');
        document.getElementById('connection-status').textContent = 'Connected to: ' + serialPort.getInfo().usbProductId + ' - ' + serialPort.getInfo().usbVendorId;
      } catch (error) {
        console.error('Error connecting to serial port:', error);
        document.getElementById('connection-status').textContent = 'Connection failed. Please try again.';
      }
    });

    // this dictionary is for the 6-pin braille output of the numbers 0-9
    // N for newline, - for negative sign, . for period, and space for whitespace
    const nDict = {
      '0': '011100',
      '1': '100000',
      '2': '101000',
      '3': '110000',
      '4': '110100',
      '5': '100100',
      '6': '111000',
      '7': '111100',
      '8': '101100',
      '9': '011000',
      'N': '010111',
      ' ': '000000',
      '-': '000011',
      '.': '010001' 
    }

    async function sendNumber() {

      // get number from input and establish variabels
      const number = document.getElementById('numberInput').value;
      console.log(number);

      // check for operation in input
      const [isOperation, resultString] = parseInput(number);

      if (isOperation) {
         console.log("Operation detected"); // continues through until done
      }
      else if (isOperation == false) {
         console.log("No operation detected");
      }
      else if (isOperation == null) {
         alert("Error! Please enter a valid operation or number.")
         return;
      }

      // give an error if number is not between -9999 and 99999\
      if (parseInt(resultString) < -9999 || parseInt(resultString) > 99999) {
        alert("The number must be between -9999 and 99999");
        return;
      }

      var numString = resultString;
      // var numString = parseInput(numString);
      console.log(numString);

      var processedNumString = "";

      const numDigits = numString.length;
      const gap = '0';
      const centerGap = '00000000'

      var outputString = "";

      // check if first string value is a negative sign
      if (numString[0] == '-') {
        processedNumString = "-N" + numString.substring(1, numDigits);
      }
      else {
         processedNumString = "N" + numString;
      }

      console.log('Processed Number String:', processedNumString)

      // add whitespace to the end of the processedNumString to make it a total of 6 characters long
      if (processedNumString.length < 6) {
        for (var i = processedNumString.length; i <= 6; i++) {
          processedNumString = processedNumString + ' ';
        }
      }

      console.log(processedNumString);
      
      // row 1
      outputString = outputString + nDict[processedNumString[0]].substring(0,2) + gap + nDict[processedNumString[1]].substring(0,2) + gap + nDict[processedNumString[2]].substring(0,2);

      // row 2
      outputString = outputString + nDict[processedNumString[0]].substring(2,4) + gap + nDict[processedNumString[1]].substring(2,4) + gap + nDict[processedNumString[2]].substring(2,4);

      // row 3
      outputString = outputString + nDict[processedNumString[0]].substring(4,6) + gap + nDict[processedNumString[1]].substring(4,6) + gap + nDict[processedNumString[2]].substring(4,6);

      // row 4 and 5 - center gap
      outputString = outputString + centerGap + centerGap;

      // row 6
      outputString = outputString + nDict[processedNumString[3]].substring(0,2) + gap + nDict[processedNumString[4]].substring(0,2) + gap + nDict[processedNumString[5]].substring(0,2);

      // row 7
      outputString = outputString + nDict[processedNumString[3]].substring(2,4) + gap + nDict[processedNumString[4]].substring(2,4) + gap + nDict[processedNumString[5]].substring(2,4);

      // row 8
      outputString = outputString + nDict[processedNumString[3]].substring(4,6) + gap + nDict[processedNumString[4]].substring(4,6) + gap + nDict[processedNumString[5]].substring(4,6);

      // send the outputString to the arduino
      sendData(outputString);
      
    }

    // parse number input for operations
    function parseInput(string) {

      var outputString = "";
      var hasOperation = false;
      
      // iterate through string length
      for (i = 0; i < string.length; i++) {
        
         switch(string[i]) {
            
            case '+':
               // check if there is already an operation
               if (hasOperation == true) {
                  alert("Only one operation is allowed");
                  return [null, string];
               }
               // add the two numbers
               var a = parseInt(string.substring(0,i));
               var b = parseInt(string.substring(i+1, string.length));
               outputString = (a + b).toString();
               hasOperation = true;
               break;
            case '-':
               // check if there is already an operation
               if (hasOperation == true) {
                  alert("Only one operation is allowed");
                  return [null, string];
               }
               // subtraction
               var a = parseInt(string.substring(0,i));
               var b = parseInt(string.substring(i+1, string.length));
               outputString = (a - b).toString();
               hasOperation = true;
               break;
            case '*':
               // check if there is already an operation
               if (hasOperation == true) {
                  alert("Only one operation is allowed");
                  return [null, string];
               }
               // multipyl the two numbers
               var a = parseInt(string.substring(0,i));
               var b = parseInt(string.substring(i+1, string.length));
               outputString = (a * b).toString();
               hasOperation = true;
               break;
            case '/':
               // check if there is already an operation
               if (hasOperation == true) {
                  alert("Only one operation is allowed");
                  return [null, string];
               }
               // divide the numbers
               var a = parseInt(string.substring(0,i));
               var b = parseInt(string.substring(i+1, string.length));
               outputString = (a / b).toFixed(2).toString();
               hasOperation = true;
               break;
            default:
               break;
         }
        

      }
      
      if (hasOperation) {
         return [true, outputString];
      }
      else {
         return [false, string];
      }
    }

  </script>
  </div>
</body>
</html>
