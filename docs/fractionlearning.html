<!DOCTYPE html>
<html>
<head>
  <title>Absolute Value Game</title>
  <meta charset="utf-8">
  <!-- import bootstrap 5.1 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/b33dd8950a.js" crossorigin="anonymous"></script>
  <link rel="icon" href="appicon.ico">
</head>
<body class="bg-dark text-light">
  <style>
    .sticky {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #000;
    }

    .btn {
      transform: translate(0,0);
      transition: transform 0.3s;
    }
    .btn:hover {
      transform: translate(0,-2px);
      transition: transform 0.3s;
    }
  </style>
  <div class="jumbotron" style="justify-content: center; text-align: center;">
  <div class="bg-dark pb-4" id="stickyHeader">
    <h1 class="pt-4">Braille Display Controller</h1>
    <h3 id="connection-status"></h3>
    <div class="pt-2">
      <button class="btn btn-primary mx-1" id="connectButton">Connect to Arduino</button>
      <button class="btn btn-danger mx-1" onclick="sendData('0000000000000000000000000000000000000000000000000000000000000000')">Clear Display</button>
      <button class="btn btn-primary mx-1" onclick="toggleSticky()" id="stickyButton"><i class="fa-solid fa-thumbtack"></i></button>
    </div>
  </div>

  <script>
    // get sticky status from local storage on page load
    if (localStorage.getItem('stickyEnabled') == 'true') {
      document.getElementById('stickyHeader').classList.add('sticky');
      document.getElementById('stickyButton').innerHTML = '<i class="fa-solid fa-xmark"></i>';
    }

    function toggleSticky() {
      const stickyHeader = document.getElementById('stickyHeader');
      if (stickyHeader.classList.contains('sticky')) {
        localStorage.setItem('stickyEnabled', 'false');
        stickyHeader.classList.remove('sticky');
        document.getElementById('stickyButton').innerHTML = '<i class="fa-solid fa-thumbtack"></i>';
      } else {
        localStorage.setItem('stickyEnabled', 'true');
        stickyHeader.classList.add('sticky');
        document.getElementById('stickyButton').innerHTML = '<i class="fa-solid fa-xmark"></i>';
      }
    }
  </script>

  <script>
    let serialPort;
    const connectButton = document.getElementById('connectButton');

    // function to connect to serial port
    connectButton.addEventListener('click', async () => {
      try {
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 9600 });
        console.log('Serial port connected.');
        // document.getElementById('connection-status').textContent = 'Status: Connected';
        // document.getElementById('connection-status').className = 'text-success';
        document.getElementById('connectButton').disabled = true;
        document.getElementById('connectButton').textContent = 'Connected';
        document.getElementById('connectButton').className = 'btn btn-success';
        // delay 2s
        setTimeout(() => {
          sendData("1111111110000001100000011000010110101001100100011000000111111111"); // symbol to show connection success
        }, 2000);
      } catch (error) {
        console.error('Error connecting to serial port:', error);
        // document.getElementById('connection-status').textContent = 'Connection failed. Please try again.';
        // document.getElementById('connection-status').className = 'text-danger';
        alert('Error connecting to serial port. Please try again.');
      }
    });

    // function to send data
    async function sendData(data) {
      if (!serialPort || !serialPort.writable) {
        console.error('Serial port not connected or not writable.');
        if(!serialPort) {
          alert('Please connect to the serial port first.');
          return;
        }
        else if(!serialPort.writable) {
          alert('Serial port is not writable. Please reconnect.');
        }
        return;
      }

      // encodes the data being sent to the arduino port
      const encoder = new TextEncoder();
      const dataArray = encoder.encode(data);

      // writing to the serial port of the arduino
      const writer = serialPort.writable.getWriter();
      await writer.write(dataArray);
      writer.releaseLock();
      console.log('Data sent to Arduino:', data);
    }
  </script>

  <div class="pt-2">
    <button class="btn btn-primary mx-1" onclick="playGame()" id="sgButton">Start Game</button>
  </div>
  <div id="gamediv" class="pt-2 container justify-content-center text-center" style="display: none !important;">
      <div class="pt-2">
         <h3 id="gamequestion">What is 1/1?</h3>
      </div>
      <div class="py-2 d-flex justify-content-center text-center">
        <div class="row">
          <div class="col-6 d-flex justify-content-center text-center" id="numAnswerButtons">
            <!-- answer buttons go here -->
          </div>
          <div class="col-6 d-flex justify-content-center text-center" id="denomAnswerButtons">
            <!-- answer buttons go here -->
          </div>
        </div>
      </div>         
      <button class="btn btn-primary mx-1" onclick="checkAnswer()">Submit</button>
      <div id="answerDiv" style="display: none !important;"></div>
      <div class="pt-2">
        <h3 id="answerStatus"></h3>
      </div>
      <div class="pt-2">
        <h3 id="pointTotal"></h3>
      </div>
      <div class="pt-2">
        <h3 id="streak"></h3>
      </div>  
  </div>

  <script>

      var pointTotal = 0;
      var streak = 0;

      const nDict = {
        '0': '011100',
        '1': '100000',
        '2': '101000',
        '3': '110000',
        '4': '110100',
        '5': '100100',
        '6': '111000',
        '7': '111100',
        '8': '101100',
        '9': '011000',
        'N': '010111', // number sign for braille 
         /* 
          https://braillebug.org/braille/math-in-braille/ - reference for the following signs
         */
        'o': '110101', // opening fraction indicator
        '/': '010010', // slash
        'c': '010111', // closing fraction indicator
        ' ': '000000', // space
        '|': '101101', // vertical bar
    }

    function playGame() {

      document.querySelector('#gamediv').style = "display: block !important";
      document.querySelector('#sgButton').innerHTML = "Next Question";
      // generate numbers 
      var num1 = 0;
      var num2 = 0;

      const numWordBank = ['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
      const denomWordBank = ['ERROR', 'whole', 'half', 'third', 'fourth', 'fifth', 'sixth', 'seventh', 'eighth', 'ninth', 'tenth', 'eleventh', 'twelfth'];

      // make sure denominator and numerator aren't zero, numerator in the single digits
      while (num1 == 0) {
        num1 = Math.floor(Math.random() * 10);
      }
      while (num2 == 0) {
        num2 = Math.floor(Math.random() * 13);
      }

      // calculate the answer and build the numstring
      var numString = "";
      numString += "o" + num1 + "/" + num2 + "c" + "  "; // build the fraction for output
      var htmlString = "How do you say ";
      htmlString += num1 + "/" + num2 + " ? ";
      document.querySelector('#gamequestion').textContent = htmlString;
      var answer;

      // get the correct numerator and 3 other random answers
      // then do the same for the denominator and 3 other random answers for 4-answer MCQ
      var correctNumerator = numWordBank[num1];
      var correctDenominator = denomWordBank[num2];
      var correctDenominatorAdjusted = correctDenominator;
      if (num1 == 1) {
        correctDenominatorAdjusted += "s";
      }

      /* 
        Randomize the answers for the numerator
      */
      var numeratorBank = [];
      numeratorBank.push(correctNumerator);
      while (numeratorBank.length < 4) {
        var randNum = Math.floor((Math.random() * 9) + 1); // *9 + 1 in order to avoid zero/error
        if (!numeratorBank.includes(numWordBank[randNum])) {
          numeratorBank.push(numWordBank[randNum]);
        }
      }

      /* 
        Randomize the answers for the denominator
      */
      var denominatorBank = [];
      denominatorBank.push(correctDenominatorAdjusted);
      while (denominatorBank.length < 4) {
        var randNum = Math.floor((Math.random() * 12) + 1); // *12 + 1 in order to avoid zero/error
        if (!denominatorBank.includes(denomWordBank[randNum])) {
          var denom = denomWordBank[randNum];
          if (num1 == 1) {
            denom += "s";
          }
          denominatorBank.push(denom);
        }
      }

      // shuffle the arrays
      numeratorBank = shuffle(numeratorBank);
      denominatorBank = shuffle(denominatorBank);

      // create buttons for each answer and add to the divs
      var numButtonDiv = document.querySelector('#numAnswerButtons');
      var denomButtonDiv = document.querySelector('#denomAnswerButtons');

      numButtonDiv.innerHTML = "";
      denomButtonDiv.innerHTML = "";

      for (var i = 0; i < 4; i++) {
        var numButton = document.createElement('button');
        numButton.className = "btn btn-primary mx-1";
        numButton.textContent = numeratorBank[i];
        numButton.onclick = function() {
          document.querySelector('#answerDiv').textContent = correctNumerator;
          checkAnswer();
        }
        numButtonDiv.appendChild(numButton);

        var denomButton = document.createElement('button');
        denomButton.className = "btn btn-primary mx-1";
        denomButton.textContent = denominatorBank[i];
        denomButton.onclick = function() {
          document.querySelector('#answerDiv').textContent = correctDenominatorAdjusted;
          checkAnswer();
        }
        denomButtonDiv.appendChild(denomButton);
      }



      console.log(numString);

      sendNumber(numString);

    }

    function sendNumber(numString) {
      
      // initialize gaps and the string to be returned
      const gap = '0';
      const centerGap = '00000000'
      var outputString = "";

      // row 1
      outputString = outputString + nDict[numString[0]].substring(0, 2) + gap + nDict[numString[1]].substring(0, 2) + gap + nDict[numString[2]].substring(0, 2);

      // row 2
      outputString = outputString + nDict[numString[0]].substring(2, 4) + gap + nDict[numString[1]].substring(2, 4) + gap + nDict[numString[2]].substring(2, 4);

      // row 3
      outputString = outputString + nDict[numString[0]].substring(4, 6) + gap + nDict[numString[1]].substring(4, 6) + gap + nDict[numString[2]].substring(4, 6);

      // row 4 and 5 - center gap
      outputString = outputString + centerGap + centerGap;

      // row 6
      outputString = outputString + nDict[numString[3]].substring(0, 2) + gap + nDict[numString[4]].substring(0, 2) + gap + nDict[numString[5]].substring(0, 2);

      // row 7
      outputString = outputString + nDict[numString[3]].substring(2, 4) + gap + nDict[numString[4]].substring(2, 4) + gap + nDict[numString[5]].substring(2, 4);

      // row 8
      outputString = outputString + nDict[numString[3]].substring(4, 6) + gap + nDict[numString[4]].substring(4, 6) + gap + nDict[numString[5]].substring(4, 6);

      // send the outputString to the arduino
      sendData(outputString);
    }

    // check for enter key press when submitting answer
    document.querySelector('#answer').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        checkAnswer();
      }
    });

    function checkAnswer() {
      // get user answer, correct answer is from the hidden div
      var userAnswer = document.querySelector('#answer').value;
      var correctAnswer = document.querySelector('#answerDiv').textContent;
      // get divs for displaying scores and answer correct/incorrect
      const answerStatus = document.querySelector('#answerStatus');
      const pointTotalDiv = document.querySelector('#pointTotal');
      const streakDiv = document.querySelector('#streak');
      if (userAnswer == correctAnswer) {
        // correct answer
        answerStatus.textContent = 'Correct!';
        answerStatus.className = 'text-success';
        pointTotalDiv.textContent = 'Points: ' + ++pointTotal;
        streakDiv.textContent = 'Streak: ' + ++streak;
      } else {
        // incorrect answer - gives feedback for the correct answer
        answerStatus.textContent = 'Incorrect. The correct answer is ' + correctAnswer;
        answerStatus.className = 'text-danger';
        streak = 0;
        streakDiv.textContent = 'Streak: ' + streak;
      }
      
      setTimeout( () => {
        answerStatus.textContent = '';
      }, 4000);

      // clear input field for next question
      document.querySelector('#answer').value = "";

      // send the correct answer to the braille display to read
      answerString = "N" + correctAnswer + "     ";
      sendNumber(answerString);

      // wait 4 seconds, then play again
      setTimeout(playGame, 4000);
    }

    /* 
      Begin code referenced from GeeksForGeeks:
      https://www.geeksforgeeks.org/how-to-shuffle-an-array-using-javascript/
    */
    function shuffle(array) {
      for (var i = array.length - 1; i > 0; i--) { 
      
          // Generate random number 
          var j = Math.floor(Math.random() * (i + 1));
                      
          var temp = array[i];
          array[i] = array[j];
          array[j] = temp;
      }
          
      return array;
    }
    /*
      End of referenced code
    */
  </script>
  

</div>
</body>
</html>